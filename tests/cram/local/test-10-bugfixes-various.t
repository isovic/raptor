Removing the identity filter exposed the problem with calculating the Alignment Score in case of aligner_edlib. The AS was simply the number of matches, which turned out to be wrong. If only number of matches is used, then indels are ignored, and lower quality alignments can prevail
The path ID information is removed using sed, so that internal labeling does not break the tests.
Note: The primary and secondary alignments have mapping quality of 3 because other regions are filtered out by the --sec-ratio value.
  $ ${BIN_DIR}/raptor -r ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/ctg.s1.000000F-95000-115000.fasta -g ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/all_contig.gfa2 -q ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/problematic_read.fasta -v 0 --align --out-fmt sam --bestn 0 --bestn-threshold 1.0 --min-idt 0.0 --sec-ratio 0.8 | sed 's/[[:space:]]pi:.*ps:i:[0-9]//g'
  @HD	VN:1.5
  @SQ	SN:ctg.s1.000000F:95000-115000	LN:20001
  m54081_181221_163846/11666180/49398_49554	0	ctg.s1.000000F:95000-115000	13308	3	1=1I70=1X54=2X1I1=1I1=1I1=3X18S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:10	AS:i:216	QS:i:0	QE:i:138	QL:i:156	TS:i:13307	TE:i:13441	TL:i:20001
  m54081_181221_163846/11666180/49398_49554	256	ctg.s1.000000F:95000-115000	4343	3	2S2=1X5=1X21=1X1=1I1=1D5=1I1=1X8=1D12=1X15=2X45=5I1=1I2=20S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:17	AS:i:178	QS:i:2	QE:i:136	QL:i:156	TS:i:4342	TE:i:4470	TL:i:20001
# These would be reported but are correctly removed because of the poor alignment score.
#  m54081_181221_163846/11666180/49398_49554	256	ctg.s1.000000F:95000-115000	5151	46	1=1X2=1X27=1X1=1X6=1I1=1X6=1I1=1D12=1X15=2X14=1X25=1X4=2X1I1=1X1=2X1=1X1=2X1=2X13S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:24	AS:i:144	QS:i:0	QE:i:143	QL:i:156	TS:i:5150	TE:i:5291	TL:i:20001
#  m54081_181221_163846/11666180/49398_49554	256	ctg.s1.000000F:95000-115000	4593	46	2S2=1X5=1X21=1X1=1X37=1X21=23D2=6D1=2D1=1X1=5D1=1D1=3D1=2D1=1D4=10D1=3D1=2D2=2D2=2D1=1D1=2D2=2D2=1D1=3D1=3D3=3D1=2D1=1D1=1D1=2D3=4D1=3D1=2D1=13D2=2D1=6D1=1D2=12D1=1D1=14D13S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:147	AS:i:-104	QS:i:2	QE:i:143	QL:i:156	TS:i:4592	TE:i:4874	TL:i:20001

The same as above, but using '--sec-ratio 0.0' so that the lower quality secondary alignments are reported.
  $ ${BIN_DIR}/raptor -r ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/ctg.s1.000000F-95000-115000.fasta -g ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/all_contig.gfa2 -q ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/problematic_read.fasta -v 0 --align --out-fmt sam --bestn 0 --bestn-threshold 1.0 --min-idt 0.0 --sec-ratio 0.0 | sed 's/[[:space:]]pi:.*ps:i:[0-9]//g'
  @HD	VN:1.5
  @SQ	SN:ctg.s1.000000F:95000-115000	LN:20001
  m54081_181221_163846/11666180/49398_49554	0	ctg.s1.000000F:95000-115000	13308	1	1=1I70=1X54=2X1I1=1I1=1I1=3X18S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:10	AS:i:216	QS:i:0	QE:i:138	QL:i:156	TS:i:13307	TE:i:13441	TL:i:20001
  m54081_181221_163846/11666180/49398_49554	256	ctg.s1.000000F:95000-115000	4343	1	2S2=1X5=1X21=1X1=1I1=1D5=1I1=1X8=1D12=1X15=2X45=5I1=1I2=20S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:17	AS:i:178	QS:i:2	QE:i:136	QL:i:156	TS:i:4342	TE:i:4470	TL:i:20001
  m54081_181221_163846/11666180/49398_49554	256	ctg.s1.000000F:95000-115000	5151	1	1=1X2=1X27=1X1=1X6=1I1=1X6=1I1=1D12=1X15=2X14=1X25=1X4=2X1I1=1X1=2X1=1X1=2X1=2X13S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:24	AS:i:144	QS:i:0	QE:i:143	QL:i:156	TS:i:5150	TE:i:5291	TL:i:20001
  m54081_181221_163846/11666180/49398_49554	256	ctg.s1.000000F:95000-115000	4593	1	2S2=1X5=1X21=1X1=1X37=1X21=23D2=6D1=2D1=1X1=5D1=1D1=3D1=2D1=1D4=10D1=3D1=2D2=2D2=2D1=1D1=2D2=2D2=1D1=3D1=3D3=3D1=2D1=1D1=1D1=2D3=4D1=3D1=2D1=13D2=2D1=6D1=1D2=12D1=1D1=14D13S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:147	AS:i:-104	QS:i:2	QE:i:143	QL:i:156	TS:i:4592	TE:i:4874	TL:i:20001

The same as above, but outputting only the primary alignment.
  $ ${BIN_DIR}/raptor -r ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/ctg.s1.000000F-95000-115000.fasta -g ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/all_contig.gfa2 -q ${PROJECT_DIR}/test-data/bugfixes/min_idt_issue/problematic_read.fasta -v 0 --align --out-fmt sam --bestn 1 | sed 's/[[:space:]]pi:.*ps:i:[0-9]//g'
  @HD	VN:1.5
  @SQ	SN:ctg.s1.000000F:95000-115000	LN:20001
  m54081_181221_163846/11666180/49398_49554	0	ctg.s1.000000F:95000-115000	13308	3	1=1I70=1X54=2X1I1=1I1=1I1=3X18S	*	0	0	TTCATCTGCGCGGGAATGACGATTCAGAAGTTACACGAAACTCAAAAAAAACGAAACCGAACGAACCGGATTTCCGCTTTTACGGGAATGACGGCGCATAAGTTCCCGTGCGGACAGACCTAGATTCGAGAACACAAAAAAAACCAAAAAGGGGGT	*	NM:i:10	AS:i:216	QS:i:0	QE:i:138	QL:i:156	TS:i:13307	TE:i:13441	TL:i:20001

Testing multiple read groups in the input BAM file and using SAM output.
  $ ${BIN_DIR}/raptor -r ${PROJECT_DIR}/test-data/bugfixes/multiple_rg/ecoli-0-100000.fasta -q ${PROJECT_DIR}/test-data/bugfixes/multiple_rg/test_multi_rg.bam --out-fmt sam -v 0 | samtools view -H | sort
  @HD	VN:1.5
  @PG	ID:baz2bam	PN:baz2bam	VN:5.0.0.6236	CL:/opt/pacbio/ppa-5.0.0/bin/baz2bam /data/pa/m54110_171115_145004.baz -o /data/pa/m54110_171115_145004 --metadata /data/pa/.m54110_171115_145004.metadata.xml -j 12 -b 12 --progress --silent --minSubLength 50 --minSnr 3.750000 --adapters /data/pa/m54110_171115_145004.adapters.fasta
  @PG	ID:bazFormat	PN:bazformat	VN:1.3.0
  @PG	ID:bazwriter	PN:bazwriter	VN:5.0.0.6236
  @PG	ID:lima	VN:1.0.0 (commit de983e0)
  @RG	ID:6b04dbdd	PL:PACBIO	DS:READTYPE=SUBREAD;Ipd:CodecV1=ip;PulseWidth:CodecV1=pw;BINDINGKIT=100-862-200;SEQUENCINGKIT=101-309-500;BASECALLERVERSION=5.0.0.6236;FRAMERATEHZ=80.000000;BarcodeFile=/pbi/dept/secondary/siv/smrtlink/smrtlink-beta/smrtsuite_166987/install/smrtlink-release_5.1.0.25817/bundles/smrtinub/current/private/pacbio/barcodes/Sequel_RSII_384_barcodes_v1/Sequel_RSII_384_barcodes_v1.barcodeset.xml;BarcodeHash=979b171f27a290d53f63edf9969c14cc;BarcodeCount=384;BarcodeMode=Symmetric;BarcodeQuality=Score	PU:m54110_171116_010407	PM:SEQUEL
  @RG	ID:8268f187	PL:PACBIO	DS:READTYPE=SUBREAD;Ipd:CodecV1=ip;PulseWidth:CodecV1=pw;BINDINGKIT=100-862-200;SEQUENCINGKIT=101-309-500;BASECALLERVERSION=5.0.0.6236;FRAMERATEHZ=80.000000;BarcodeFile=/pbi/dept/secondary/siv/smrtlink/smrtlink-beta/smrtsuite_166987/install/smrtlink-release_5.1.0.25817/bundles/smrtinub/current/private/pacbio/barcodes/Sequel_RSII_384_barcodes_v1/Sequel_RSII_384_barcodes_v1.barcodeset.xml;BarcodeHash=979b171f27a290d53f63edf9969c14cc;BarcodeCount=384;BarcodeMode=Symmetric;BarcodeQuality=Score	PU:m54110_171115_145004	PM:SEQUEL
  @SQ	SN:gi|545778205|gb|U00096.3|	LN:100000

Testing multiple read groups in the input BAM file and using BAM output.
  $ ${BIN_DIR}/raptor -r ${PROJECT_DIR}/test-data/bugfixes/multiple_rg/ecoli-0-100000.fasta -q ${PROJECT_DIR}/test-data/bugfixes/multiple_rg/test_multi_rg.bam --out-fmt bam -v 0 | samtools view -H | sort
  @HD	VN:1.5	SO:unknown	pb:3.0.7
  @PG	ID:baz2bam	PN:baz2bam	VN:5.0.0.6236	CL:/opt/pacbio/ppa-5.0.0/bin/baz2bam /data/pa/m54110_171115_145004.baz -o /data/pa/m54110_171115_145004 --metadata /data/pa/.m54110_171115_145004.metadata.xml -j 12 -b 12 --progress --silent --minSubLength 50 --minSnr 3.750000 --adapters /data/pa/m54110_171115_145004.adapters.fasta
  @PG	ID:bazFormat	PN:bazformat	VN:1.3.0
  @PG	ID:bazwriter	PN:bazwriter	VN:5.0.0.6236
  @PG	ID:lima	VN:1.0.0 (commit de983e0)
  @RG	ID:6b04dbdd	PL:PACBIO	DS:READTYPE=SUBREAD;Ipd:CodecV1=ip;PulseWidth:CodecV1=pw;BINDINGKIT=100-862-200;SEQUENCINGKIT=101-309-500;BASECALLERVERSION=5.0.0.6236;FRAMERATEHZ=80.000000;BarcodeFile=/pbi/dept/secondary/siv/smrtlink/smrtlink-beta/smrtsuite_166987/install/smrtlink-release_5.1.0.25817/bundles/smrtinub/current/private/pacbio/barcodes/Sequel_RSII_384_barcodes_v1/Sequel_RSII_384_barcodes_v1.barcodeset.xml;BarcodeHash=979b171f27a290d53f63edf9969c14cc;BarcodeCount=384;BarcodeMode=Symmetric;BarcodeQuality=Score	PU:m54110_171116_010407	PM:SEQUEL
  @RG	ID:8268f187	PL:PACBIO	DS:READTYPE=SUBREAD;Ipd:CodecV1=ip;PulseWidth:CodecV1=pw;BINDINGKIT=100-862-200;SEQUENCINGKIT=101-309-500;BASECALLERVERSION=5.0.0.6236;FRAMERATEHZ=80.000000;BarcodeFile=/pbi/dept/secondary/siv/smrtlink/smrtlink-beta/smrtsuite_166987/install/smrtlink-release_5.1.0.25817/bundles/smrtinub/current/private/pacbio/barcodes/Sequel_RSII_384_barcodes_v1/Sequel_RSII_384_barcodes_v1.barcodeset.xml;BarcodeHash=979b171f27a290d53f63edf9969c14cc;BarcodeCount=384;BarcodeMode=Symmetric;BarcodeQuality=Score	PU:m54110_171115_145004	PM:SEQUEL
  @SQ	SN:gi|545778205|gb|U00096.3|	LN:100000

In Raptor version <=0.19.3 marking of secondary and supplementary alignments was wrong. This could have caused issues like the one described in test-data/bugfixes/missing_primary_alignment, where Raptor would only output a single alignment marked as secondary, but no accompanying primary alignment.
The reason this happened is because the alignment which was marked as primary had a lower AS than the secondary one, and got filtered out due to the --bestn* settings. This has been fixed in versions >0.19.3.
  $ ${BIN_DIR}/raptor -r ${PROJECT_DIR}/test-data/bugfixes/missing_primary_alignment/test.ref.fasta -q ${PROJECT_DIR}/test-data/bugfixes/missing_primary_alignment/test.read.fasta --align -v 0
  m54047_190612_045721/4260489/21917_30057	8140	5952	8140	+	ctg.s2.000006F:1-25000	25000	0	1765	2188	1765	3	cm:i:1660	NM:i:560	AS:i:1438	fg:i:0	pi:i:1	pj:i:0	pn:i:1	ps:i:0	cg:Z:2=1I1=2I2=1I1=3I2=1I3=1I1=1I1=1I10=2I4=1I3=1I7=3I12=1I4=1I6=1I2=1I2=1I14=1I1=1I1=1I3=1D6=1I9=1X5=1X7=2I3=1X2I2=1I5=4I5=1X5=1I2=1I3=1D4=1I8=3I4=2I2=1I6=1I18=1I5=1I1=1I10=1I3=1I1=1I1=1I4=3I3=2I11=2I1=1X7=1X5=1X1=1I2=1I1=1I4=2I2=1I1=1I5=1D11=3I5=2I4=1X1D2=2I4=1X1I1=1I2=1I3=2I6=1I1=1X3=1X2=1X1I7=1D2=1X1D3=1X1=1I2=1I2=1I4=1I4=1X8=1X5=8I5=1I3=1I7=1X4=8I5=1D3=1I2=1X1=1I2=2I5=2I5=2I2=1X2=1D3=1I8=1D10=1I2=2I4=1I5=1I7=2I6=1I2=1I4=3I14=1X1D7=3I7=1I2=1X5=2I4=1D9=1I5=1I3=1I7=1X5=1X8=1D7=2I3=1I7=1I2=1I1=1I3=1I2=1I11=3I5=1D16=2I7=2I1=1I13=1X1D1=1X2=1D5=1I5=4I11=1I1=1I8=1I7=1D1=1I2=4I7=7I1=1I6=3I3=5I3=1I7=2I2=1I6=4I12=1I2=2I2=1I1=1X10=1I1=1I7=4I3=1I1=1I13=1X3=1I10=7I13=1I7=1I10=1X2=1X6=1I22=1X5I5=1I1=2I3=1X4=1D4=2I1=1I3=1I5=1X1=1X6=2I4=1I2=1I5=1X2=2I5=1I15=1I4=1D4=1I3=1I5=4I1=1I16=1I1=2I3=1I4=1D16=1I1=1X1=1X1=1I5=1I1=1I1=1I2=4I4=1I5=2I3=1X3=1X2=2I1=1I5=1X1=1X7=1I5=1I1=1I3=1D2=1I3=1I4=1I1=1I5=1I6=2I8=1I3=1I6=1D2=1X2=2I11=1X1I12=1X7=2I4=1D3=1I11=4I1=2I2=1I3=2I4=1X1=1I3=2I8=1X7=2I6=1X8=1X6=2D3=1I2=1I6=1X4=1I2=1I2=1D1=1X5=1X2I7=1I3=1X2=1D4=1I2=1I6=2I4=3X8=1X4=5I3=1I3=1I4=1I2=1I7=1I4=1D3=1X1I5=1D8=4I3=1I2=1I7=7I2=1X18=2I12=1X3=1X3=2I2=1I1=1X1=1I1=2I4=1I2=1I1=1X7=2I7=1I3=1I4=1I3=1I2=1I6=2I3=6I6=1I4=1I2=1X2=1I4=1I9=1I5=2I2=1I11=2D9=1I1=2I15=2X1=1I1=2I7=4I18=1X1I1=1I3=1I5=1I2=1I1=1I3=1D7=1X1=1I5=1I1=1I1=1X1=1I4=1X5=4I3=1I1=1I6=2I3=1I1=1I2=1I2=1I4=4I12=1I8=6I12=3X2=1I6=3I2=1D3=1I13=1I12=1I2=1I5=1I4=1I4=2I3=2I1=1I2=1I15=1I7=2I5=3I6=1I5=5I6=1I7=1I3=6I7=1X4=1X1I2=1I2=1I2=1I1=1I4=5I5=3I2=1I2=1I1=1I4=1I4=1I6=1I11=1I3=1I1=
  m54047_190612_045721/4260489/21917_30057	8140	0	1859	-	ctg.s2.000006F:1-25000	25000	235	1763	1859	1528	3	cm:i:1439	NM:i:444	AS:i:1366	fg:i:272	pi:i:0	pj:i:0	pn:i:1	ps:i:0	cg:Z:15=1I4=1D6=1I4=1X6=1I5=1X3=1I5=1I6=2I9=2I2=1I2=1I4=2I3=3I7=2I4=4I3=1I2=1I3=1D17=1I15=1I5=1I2=2I1X8=3I3=1I9=1I2=1X9=1I1=4I1=1I4=1I3=1I3=4I9=3I3=1D10=1I1=1I1=3I4=1I14=1D3=1I1=2I1X7=3I2=1X2=1I1=3I4=3I2=1I4=1X11=3I2=1I3=1I5=1I1=1I3=1D2=2I1=1I1=1I3=1I13=1I2=2I4=1I6=1X5=1I2=1D6=1I1=3I7=1I5=1X1=1X6=1I3=1I5=1I1=1X10=1I3=1D11=1X9=4I1=3I3=1X12=3I6=1I3=1I8=1I1=1D4=1D15=1I10=1X4=1I4=1I2=1I2=1X4=1X4=1I1=4I1=1I1=1I5=1I11=3I3=4I4=1I6=1I4=1I13=1I1=1I6=2I4=2I13=1I9=1I8=1I1=6I6=1I11=1I2=1X1=1I5=1I1=3I3=1I1=2I7=1X1=1I7=1I1=3I15=1I7=1I5=1X2=2I2=1I2=1I5=1I10=1I1=1I2=2I1X5=2I2=1I14=1I7=2D1=1X1=3X14=2I1=1I2=1X1=1X4=1I5=2I11=2I5=3I6=1X2=1I2=1I7=1D10=1I6=1I1=1I3=1X1=1D5=1I10=2I1=1I3=2I4=1I7=2I6=1I1X5=1I3=1I4=2I2=1X3=1X10=1I5=1X5=1I1=1X3=1X1=1I5=1I5=3I3=2I4=1I2=3I2=1X12=1I9=3I6=1X3=1I3=2I1=1I1=1I8=2I8=3I2X5=1I2=1I3=1I7=1X1=1I4=1D2=1X9=1X2=3I3=2X4=2I6=1X4=1I5=2X1=1X2=1I8=1X2=2I1=1X1=1I14=1X1=1X7=1X5=5I1=1I9=1X3=2I1=1D8=1I8=1D10=1I6=2I6=1D1=1I1=1I1=2I4=2I7=1I1=1I11=2I9=1I7=1I1=2I1=6I4=1I8=1I1=1I2=1X4=1I2=2I7=1I3=1D4=1X1=1I3=1I2=1X8=1I4=1I3=1X3=1I22=1I17=1I2=5I4=1I7=1I1=8I1=1I14=1D21=3I3=1I1=1I9=4I3=1I3=2I6=1I2=1D8=1I7=1D6=1I1X2=1X5=1I3=1I2=1X2=3I3=1X5=1I8=1I6=1I2=2I6=1X2=1X2=1D8=1X8=1I9=1D5=1I5=1I9=1I3=1I2=3I7=3I6=1I1=1I4=1D1=1I1X5=1I3=2I6=1I1=1I8=1I1=2I1=
